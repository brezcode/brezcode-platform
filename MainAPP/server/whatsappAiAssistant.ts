import { WhatsAppService } from './whatsappService';
import { db } from './db';
import { whatsappAiSessions, whatsappContacts, whatsappConversations } from '../shared/whatsapp-schema';
import { eq, and } from 'drizzle-orm';

export interface ConversationContext {
  phoneNumber: string;
  assistantType: 'coaching' | 'sales' | 'support';
  sessionData: any;
  messageHistory: Array<{
    role: 'user' | 'assistant';
    content: string;
    timestamp: string;
  }>;
}

export class WhatsAppAiAssistant {
  private whatsappService: WhatsAppService;

  constructor() {
    this.whatsappService = WhatsAppService.getInstance();
  }

  async processIncomingMessage(phoneNumber: string, messageContent: string, messageType: string = 'text'): Promise<void> {
    try {
      console.log(`ü§ñ Processing WhatsApp message from ${phoneNumber}: ${messageContent.substring(0, 100)}...`);

      // Get or create contact and determine conversation context
      let contact = await this.whatsappService.getContact(phoneNumber);
      
      if (!contact) {
        // New contact - start with support context by default
        await this.whatsappService.updateOrCreateContact(phoneNumber, {
          phoneNumber,
          conversationContext: 'support'
        });
        contact = { phoneNumber, conversationContext: 'support' } as any;
      }

      // Get conversation history for context
      const conversationHistory = await this.whatsappService.getConversationHistory(phoneNumber, 10);
      
      // Determine which AI assistant to use based on conversation context and message content
      const assistantType = await this.determineAssistantType(messageContent, contact.conversationContext, conversationHistory);
      
      // Get or create AI session
      const aiSession = await this.getOrCreateAiSession(phoneNumber, assistantType);
      
      // Process message based on assistant type
      let response = '';
      switch (assistantType) {
        case 'coaching':
          response = await this.processCoachingMessage(phoneNumber, messageContent, aiSession);
          break;
        case 'sales':
          response = await this.processSalesMessage(phoneNumber, messageContent, aiSession);
          break;
        case 'support':
        default:
          response = await this.processSupportMessage(phoneNumber, messageContent, aiSession);
          break;
      }

      // Send response via WhatsApp
      if (response) {
        await this.whatsappService.sendTextMessage(phoneNumber, response);
        
        // Update AI session
        await this.updateAiSession(aiSession.id, {
          messageCount: aiSession.messageCount + 1,
          lastInteractionAt: new Date()
        });
      }

      console.log(`‚úÖ WhatsApp AI response sent to ${phoneNumber} via ${assistantType} assistant`);

    } catch (error) {
      console.error('‚ùå Error processing WhatsApp message:', error);
      
      // Send error response
      await this.whatsappService.sendTextMessage(
        phoneNumber, 
        "I apologize, but I'm experiencing technical difficulties. Please try again in a few moments, or type 'HELP' for assistance."
      );
    }
  }

  private async determineAssistantType(messageContent: string, currentContext: string, history: any[]): Promise<'coaching' | 'sales' | 'support'> {
    const message = messageContent.toLowerCase();
    
    // Keywords for different assistant types
    const coachingKeywords = ['coach', 'health', 'wellness', 'breast', 'self-exam', 'prevention', 'symptoms', 'doctor', 'medical'];
    const salesKeywords = ['price', 'cost', 'buy', 'purchase', 'plan', 'subscription', 'upgrade', 'premium', 'features'];
    const supportKeywords = ['help', 'support', 'problem', 'issue', 'error', 'bug', 'account', 'login', 'password', 'interactive', 'button'];

    // Check for explicit context switching
    if (message.includes('talk to coach') || message.includes('health coach')) {
      return 'coaching';
    }
    if (message.includes('sales') || message.includes('pricing')) {
      return 'sales';
    }
    if (message.includes('support') || message.includes('help')) {
      return 'support';
    }

    // Check for keyword matches
    const coachingMatches = coachingKeywords.filter(keyword => message.includes(keyword)).length;
    const salesMatches = salesKeywords.filter(keyword => message.includes(keyword)).length;
    const supportMatches = supportKeywords.filter(keyword => message.includes(keyword)).length;

    // Determine based on keyword frequency
    if (coachingMatches > salesMatches && coachingMatches > supportMatches) {
      return 'coaching';
    }
    if (salesMatches > coachingMatches && salesMatches > supportMatches) {
      return 'sales';
    }
    if (supportMatches > 0) {
      return 'support';
    }

    // Fall back to current context or default to support
    return currentContext as 'coaching' | 'sales' | 'support' || 'support';
  }

  private async processCoachingMessage(phoneNumber: string, message: string, aiSession: any): Promise<string> {
    try {
      // Use the existing BrezcodeAvatarService for health coaching
      const { BrezcodeAvatarService } = await import('./services/brezcodeAvatarService');
      
      // Get conversation history for context
      const conversationHistory = await this.whatsappService.getConversationHistory(phoneNumber, 10);
      const formattedHistory = conversationHistory.map(msg => ({
        role: msg.direction === 'inbound' ? 'user' : 'assistant',
        content: msg.content || '',
        timestamp: msg.timestamp?.toISOString() || new Date().toISOString()
      }));

      // Generate Dr. Sakura's response (adapt for WhatsApp)
      const response = await BrezcodeAvatarService.generateDrSakuraResponse(
        phoneNumber, // Use phone number as user ID
        message,
        formattedHistory,
        { platform: 'whatsapp', assistantType: 'coaching' }
      );

      // Format response for WhatsApp (keep it concise)
      let whatsappResponse = response.content;
      
      // Add coaching call-to-actions
      if (message.toLowerCase().includes('learn more') || message.toLowerCase().includes('education')) {
        whatsappResponse += `\n\nüí° *Want to learn more?* Type:
‚Ä¢ "SELF-EXAM" for self-examination guide
‚Ä¢ "PREVENTION" for prevention tips
‚Ä¢ "SYMPTOMS" for warning signs
‚Ä¢ "SUPPORT" for emotional support`;
      }

      return whatsappResponse;

    } catch (error) {
      console.error('‚ùå Error in coaching assistant:', error);
      return `Hello! I'm Dr. Sakura, your breast health coach. üå∏

I'm here to provide personalized guidance on breast health, self-examinations, and wellness. 

How can I support your health journey today?

Type "MENU" to see all available options.`;
    }
  }

  private async processSalesMessage(phoneNumber: string, message: string, aiSession: any): Promise<string> {
    try {
      const message_lower = message.toLowerCase();

      // Handle common sales inquiries
      if (message_lower.includes('price') || message_lower.includes('cost') || message_lower.includes('plan')) {
        return `üíº **Brezcode Health Plans**

üå∏ **Wellness Plan** - $29/month
‚Ä¢ Unlimited Dr. Sakura coaching
‚Ä¢ Self-exam reminders
‚Ä¢ Health tracking

üè• **Premium Plan** - $49/month  
‚Ä¢ Everything in Wellness
‚Ä¢ Advanced skin analysis
‚Ä¢ Priority support
‚Ä¢ Expert consultations

‚ú® **Family Plan** - $79/month
‚Ä¢ Up to 4 family members
‚Ä¢ All Premium features
‚Ä¢ Family health dashboard

*Ready to start your health journey?*
Type "START TRIAL" for a 7-day free trial!`;
      }

      if (message_lower.includes('feature') || message_lower.includes('what do you')) {
        return `üöÄ **What Brezcode Offers:**

ü§ñ **AI Health Coach**: Dr. Sakura provides 24/7 personalized guidance
üì± **Smart Reminders**: Never miss self-exams or check-ups
üîç **Health Analysis**: Advanced screening tools
üìä **Progress Tracking**: Monitor your wellness journey
üë®‚Äç‚öïÔ∏è **Expert Access**: Connect with healthcare professionals

*Interested in learning more?*
Type "DEMO" for a personalized walkthrough!`;
      }

      if (message_lower.includes('trial') || message_lower.includes('free')) {
        return `üéâ **Start Your FREE 7-Day Trial!**

Experience all Premium features:
‚úÖ Unlimited AI coaching sessions
‚úÖ Advanced health tracking
‚úÖ Personalized recommendations
‚úÖ 24/7 support access

*No credit card required!*

To start your trial, I'll need:
1. Your name
2. Email address

Just reply with: "My name is [NAME] and my email is [EMAIL]"

Questions? Type "HELP" anytime!`;
      }

      if (message_lower.includes('help') || message_lower.includes('support')) {
        return `ü§ù **Sales Support Menu:**

Type one of these options:
‚Ä¢ **PLANS** - View all pricing plans
‚Ä¢ **FEATURES** - See what Brezcode offers
‚Ä¢ **TRIAL** - Start your free trial
‚Ä¢ **DEMO** - Request a personal demo
‚Ä¢ **COMPARE** - Compare plan features
‚Ä¢ **CONTACT** - Speak with sales team

Questions about our health coaching? Type "COACH" to speak with Dr. Sakura! üå∏`;
      }

      // Default sales response
      return `üëã Welcome to Brezcode Sales!

I'm here to help you find the perfect health plan for your needs.

üéØ **Popular Options:**
‚Ä¢ Type "PLANS" to see pricing
‚Ä¢ Type "TRIAL" to start free
‚Ä¢ Type "FEATURES" to learn more

Have specific questions? Just ask! 
For health advice, type "COACH" to speak with Dr. Sakura üå∏`;

    } catch (error) {
      console.error('‚ùå Error in sales assistant:', error);
      return "I'm having trouble accessing our pricing information right now. Please type 'HELP' or try again in a moment.";
    }
  }

  private async processSupportMessage(phoneNumber: string, message: string, aiSession: any): Promise<string> {
    try {
      const message_lower = message.toLowerCase();

      // Handle common support inquiries
      if (message_lower.includes('help') || message_lower.includes('menu') || message_lower === 'start') {
        return `üÜò **Brezcode Support Menu**

Choose what you need help with:

üè• **Health Coaching** - Type "COACH"
üíº **Sales & Pricing** - Type "SALES" 
üîß **Technical Support** - Type "TECH"
üì± **Account Help** - Type "ACCOUNT"
‚ùì **General Questions** - Type "FAQ"

Or just describe your issue and I'll help!

*Need urgent health advice? Type "URGENT" to connect immediately.*`;
      }

      if (message_lower.includes('account') || message_lower.includes('login') || message_lower.includes('password')) {
        return `üîê **Account Support**

**Common Issues:**
‚Ä¢ **Forgot Password** - Type "RESET PASSWORD"
‚Ä¢ **Can't Login** - Type "LOGIN HELP" 
‚Ä¢ **Update Profile** - Type "PROFILE"
‚Ä¢ **Billing Questions** - Type "BILLING"
‚Ä¢ **Cancel Subscription** - Type "CANCEL"

**Need immediate help?** 
üìû Call: 1-800-BREZCODE
üìß Email: support@brezcode.com

I'm here to help troubleshoot! What specific issue are you experiencing?`;
      }

      if (message_lower.includes('tech') || message_lower.includes('bug') || message_lower.includes('error')) {
        return `üîß **Technical Support**

I can help with:
‚Ä¢ App crashes or freezing
‚Ä¢ Feature not working properly  
‚Ä¢ Sync issues
‚Ä¢ Notification problems
‚Ä¢ Performance issues

**Quick Fixes:**
1. Try restarting the app
2. Check your internet connection
3. Update to latest version

**Still having issues?**
Please describe:
‚Ä¢ What were you trying to do?
‚Ä¢ What happened instead?
‚Ä¢ When did this start?

I'll get this sorted for you! üõ†Ô∏è`;
      }

      if (message_lower.includes('urgent') || message_lower.includes('emergency')) {
        return `üö® **Urgent Support**

For **medical emergencies**, please:
üìû Call 911 (US) or your local emergency number
üè• Visit your nearest emergency room

For **urgent health questions**:
Type "COACH" to speak with Dr. Sakura immediately üå∏

For **account emergencies** (security concerns):
üìß Email: urgent@brezcode.com
üìû Call: 1-800-BREZCODE (24/7)

I'm here to help with immediate non-emergency support needs. What's happening?`;
      }

      if (message_lower.includes('cancel') || message_lower.includes('unsubscribe')) {
        return `üòî Sorry to see you considering leaving!

**Before you go:**
‚Ä¢ Is there an issue we can fix?
‚Ä¢ Would you like to pause instead?
‚Ä¢ Need help with something specific?

**To proceed with cancellation:**
1. Type "CONFIRM CANCEL"
2. I'll guide you through the process
3. You'll retain access until your billing period ends

**Want to talk to someone?**
üìû Call: 1-800-BREZCODE
üìß Email: retention@brezcode.com

What's prompting you to cancel? Maybe I can help! üíô`;
      }

      // Default support response
      return `üëã **Brezcode Customer Support**

I'm here to help with:
‚úÖ Account questions
‚úÖ Technical issues  
‚úÖ Billing support
‚úÖ Feature guidance
‚úÖ General questions

**Quick Start:**
‚Ä¢ Type "MENU" for all options
‚Ä¢ Describe your issue in detail
‚Ä¢ Type "COACH" for health questions üå∏
‚Ä¢ Type "SALES" for plan information üíº

What can I help you with today?`;

    } catch (error) {
      console.error('‚ùå Error in support assistant:', error);
      return "I'm experiencing technical difficulties. Please try again or contact support@brezcode.com for immediate assistance.";
    }
  }

  private async getOrCreateAiSession(phoneNumber: string, assistantType: string): Promise<any> {
    try {
      // Check for existing active session
      const [existingSession] = await db
        .select()
        .from(whatsappAiSessions)
        .where(
          and(
            eq(whatsappAiSessions.phoneNumber, phoneNumber),
            eq(whatsappAiSessions.aiAssistantType, assistantType)
          )
        )
        .limit(1);

      if (existingSession) {
        return existingSession;
      }

      // Create new session
      const [newSession] = await db
        .insert(whatsappAiSessions)
        .values({
          phoneNumber,
          aiAssistantType: assistantType,
          sessionData: JSON.stringify({}),
          messageCount: 0,
          lastInteractionAt: new Date()
        })
        .returning();

      return newSession;
    } catch (error) {
      console.error('‚ùå Error managing AI session:', error);
      return {
        id: 0,
        phoneNumber,
        aiAssistantType: assistantType,
        sessionData: '{}',
        messageCount: 0,
        lastInteractionAt: new Date()
      };
    }
  }

  private async updateAiSession(sessionId: number, updates: any): Promise<void> {
    try {
      if (sessionId > 0) {
        await db
          .update(whatsappAiSessions)
          .set({
            ...updates,
            updatedAt: new Date()
          })
          .where(eq(whatsappAiSessions.id, sessionId));
      }
    } catch (error) {
      console.error('‚ùå Error updating AI session:', error);
    }
  }

  async sendWelcomeMessage(phoneNumber: string): Promise<void> {
    const welcomeMessage = `üå∏ **Welcome to Brezcode!**
*Your AI Health Coach at +852 94740952*

I'm your AI assistant, here to help with:

üè• **Health Coaching** (Dr. Sakura)
üíº **Sales & Pricing Information**  
üÜò **Customer Support**

**Quick Start:**
‚Ä¢ Type "COACH" for health guidance
‚Ä¢ Type "SALES" for pricing info
‚Ä¢ Type "HELP" for support menu

How can I assist you today?`;

    await this.whatsappService.sendTextMessage(phoneNumber, welcomeMessage);
  }

  async sendProactiveMessage(phoneNumber: string, messageType: 'reminder' | 'tip' | 'followup', content: string): Promise<void> {
    let formattedMessage = '';
    
    switch (messageType) {
      case 'reminder':
        formattedMessage = `üîî **Health Reminder**\n\n${content}\n\nReply "STOP" to pause reminders or "HELP" for support.`;
        break;
      case 'tip':
        formattedMessage = `üí° **Daily Health Tip**\n\n${content}\n\nWant more tips? Type "COACH" to chat with Dr. Sakura! üå∏`;
        break;
      case 'followup':
        formattedMessage = `üëã **Following up...**\n\n${content}\n\nNeed help? Type "SUPPORT" anytime!`;
        break;
    }

    await this.whatsappService.sendTextMessage(phoneNumber, formattedMessage);
  }
}

export default WhatsAppAiAssistant;